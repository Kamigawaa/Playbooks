# Malware Playbook

[[_TOC_]]

## Scope
This Playbook covers

## 1. Preparation

<details>
<summary>Expand/Colapse</summary>

- Create and maintain a list of 
    - all domains owned by Company.
        - This can prevent you from taking actions against our own domains
    - all people of can register domains
- Create email template 
    - to notify all employees of ongoing phishing campaing against the organization 
    - to contact hosting companies for domain take down
    - to inform 3rd party to take actions against phishing on there infra (Microsoft, Fedex, Apple, etc.)
- Ensure that:
    - Mail anti-malware/anti-spam/anti-phish solutions are in place.
    - Users know how to report phish
    - Detection exists for office documents spawning processes
        - PowerShell
        - CMD
        - WMI
        - MSHTA
        - Etc.
- Perform Firedrill to ensure all aspects of the Playbook are working
    - After publication
    - At least once a year
    - Test/Validate: 
        - [Customer's Cards](Customers)
        - Internal Contact and Escalation Paths
- Review threat intelligence for 
    - threats to the organisation, 
    - brands and the sector, 
    - common patterns 
    - newly developing risks and vulnerabilities
- Ensure  appropriate  access  to  any  necessary  documentation  and  information, including out-of-hours access, for the following
    - IR Playbgns to highlight information security risks faced by employees, including: 
    - Phishing attacks and malicious emails;
    - Ransomware;
    - Reporting a suspected cyber incident.

### Tool Access and Provisioning

#### Tool1
Please referer to [Tool1 Documentation](../Products/TOOL.md)

#### Tool2
Please referer to [Tool2 Documentation](../Products/TOOL.md)

### Assets List
- A list of assets and owner should exists and be available for the following
    - Customers Assets
        - Owners
        - Contacts
        - Pre authorized actions
    - Company Assets (Including all filiale like and business units)
        - Owners
        - Contacts
        - Administrators
        - Pre autorized actions
- Type of assets inventory needed
    - Endpoints
    - Servers
    - Network Equipements
    - Security Appliances
    - Network Ranges
        - Public
        - Private
        - VPN / Out of Band
            - Employees
            - Partners
            - Clients

</details>

## 2. Detect
<details>
<summary>Expand/Colapse</summary>

### Workflow
<details open>
<summary>Expand/Colapse</summary>

![Malware Workflow](Workflows/Malware-Workflow-Detect.png)

</details>

### MD1. Identify Threat Indicators
<details open>
<summary>Expand/Colapse</summary>

#### Alerts
Alerts are be generated by differents systems owned by the Security/SOC team. The main sources for alerts are  
- Tickets
- SIEM
- Anti-Virus / EDR
- Reports
    - DNS
    - Web Proxy
- Errors from mail servers

#### Notifications
Notifications are comming from external sources usually via email, Teams or phone. The main sources for notifications are  
- Users (internal)
- Recipents of emails (external)
- Third Parties
- ISP
- Mail Providers
- Computer is 
    - Slow
    - Crash unexpectedly 

</details>

### MD2. Indentify Risks Factors
<details open>
<summary>Expand/Colapse</summary>

#### Common
- Credential Theft
- Malware Delivery
- Criminal Activites
    - Blackmail / Ransom

#### Company Specific
- Reputation damage
- Financial Losses
    - Lost of conctrat
    - Contract not renewed
    - Lower bid to our clients
    - Fines
        - Regulation

</details>

### MD3. Data Collection
This section describe the information that should be collected and documented about the incident  
There is a lot of ressources to help you with that phase [here](../Tools/README.md)

<details open>
<summary>Expand/Colapse</summary>

Files 
- Hash
- Reputation
- Publisher
- Behavior

Domains  
- Reputation
- Registrar
- Owner
- IP
- Multistage / Redirect
- Technologies of the site
    - WordPress
    - Joomla
    - Custom Page (credential phish)

IP  
- Reputation
- Owner
- Geo Localisation
- Other domains on that IP

</detials>

### MD4. Categorize
<details open>
<summary>Expand/Colapse</summary>

Determine type of malware
- Ransomware
- C2
- Exfiltration
- Worm / Lateral Movement
- Credential Theft
- Banking
- Trojan / RAT
- Adware / PUP
- etc. 

</details>

### MD5. Is it a Ransomware ?
As time is VERY sensitive in the case of a Ransomware:  
- Send a communication to the Security Mailing List
- Ping everyone in the Security Teams Chat
- Go to the [Ransomware Playbook](../IRP-Ransomware/README.md)
    - If the Playbook doesn't exist, follow this one

### MD6. Is it a Worm ?
As time is sensitive in the case of a Worm:  
- Send a communication to the Security Mailing List
- Ping everyone in the Security Teams Chat
- Go to the [Worm Playbook](../IRP-Worm/README.md)
    - If the Playbook doesn't exist, follow this one

### MD7. Triage 
<details open>
<summary>Expand/Colapse</summary>

Determine
- Impact
    - Of the malware destroying things
    - Is the malware proliferating (infecting other hosts) 
    - Financial
    - Blue Screen of Death (or other crash)
    - Data loss
    - etc. 
- Scope: Number and list of hosts that
    - Have the files
        - Hash
        - File name
        - RegEx match (ie: INVOICE-12345.docx where `12345` is 5 random digit)
    - Attempted to connect to the
        - URLs
        - IP
        - Ports
    - That have the registry keys
    - Any other IOCs found

### MD8. Is it a False Positive?

If it's a False Positive:  
- Document and close the incident

If it's a True Positive:  
- Send communication to
    - Security Team
    - Admin Teams
    - Affected Syntac Entities
    - Affected Clients
- Go to Analyze phase

</details>
</details>
</details>

## 3. Analyze
<details open>
<summary>Expand/Colapse</summary>

### Workflow
<details open>
<summary>Expand/Colapse</summary>

![Malware Workflow](Workflows/Malware-Workflow-Analyze.png)

</details>

### MA1. Verify
<details open>
<summary>Expand/Colapse</summary>

In conjonction with a senior member of the SOC  
- Double check previous data
- Rule out False Positive

</details>

### MA2. Is this a Major/Critical Incident?
If this incident is deemed **Major or Critical** by the senior analyst go to the [Critical Incident Playbook](../IRP-Critical/)


### MA3. Identify IOCs
<details open>
<summary>Expand/Colapse</summary>

Don't forget to look at **ALL** the tabs of the tools. Not just detection rate.  
For example, the tabs `Details` and `Behavior` of VirusTotal are very informative about who published the file and what the file did to the system.  

- Validate file hashes
    - [VirusTotal](../Tools/README.md#virus-total)
    - [Hybrid Analysis](Tools/README.md#hybrid-analysis)
- Validate links
    - [VirusTotal](../Tools/README.md#virus-total)
    - [Hybrid Analysis](../Tools/README.md#hybrid-analysis)
    - [URLScan](../Tools/README.md#urlscan)
- ID other addresses, domains, IPs
    - [VirusTotal](../Tools/README.md#virus-total)
    - [Hybrid Analysis](../Tools/README.md#hybrid-analysis)
    - [Talos Intelligence](../Tools/README.md#hybrid-analysis)
    - [Domain Dossier](../Tools/README.md#domain-dossier)
- Search Threat Intel sources
    - [VirusTotal](../Tools/README.md#virus-total)
    - [Hybrid Analysis](../Tools/README.md#hybrid-analysis)
    - [Talos Intelligence](../Tools/README.md#hybrid-analysis)
- Disk forensics on endpoint (if requiered)

</details>


### MA4. Extract IOCs
<details open>
<summary>Expand/Colapse</summary>

Using a *PRIVATE* sandbox run the malware sample (files) and try to access the URLs  
Collect the following informations:  
- Network connections 
- Registries modifications
- Files 
    - droped
    - accessed
    - modified
- Deobfuscated script
    - From Script Block (for PowerShell)
- New services
    - Created
    - Launched
- New scheduled tasks
- New WMI provider(s)

</details>

### MA5. Submit Samples to Partners
<details open>
<summary>Expand/Colapse</summary>

If the malware(s) was not detected/blocked by the security stack  
- Submit Samples to Security Vendor
- Submit URLs, IP, Domains 

</details>

### MA6. Scan Enterprise
<details open>
<summary>Expand/Colapse</summary>

- Update AV / EDR 
    - Engine
    - Ruleset 
    - Policies
- Update FW, IDS, etc. rules with IOCs
- Search endpoints for IOCs with EDR
- Search SIEM for IOCs
- Search Firewall, Proxy, DNS logs for IOCs

</details>

### MA7. What Was Access
<details open>
<summary>Expand/Colapse</summary>

- Look for signs of lateral Movement
- Review firewall logs 
    - Network appliances (ie: Cisco ASA)
    - endpoint (ie: Windows local firewall, EDR, AV, etc.)
- Review netflows

</details>

### MA8. Update Scope
<details open>
<summary>Expand/Colapse</summary>

- Update lists of
    - affected endpoints
    - affected Company Entities
    - affected clients

</details>

### MA9. Scope Validation
<details open>
<summary>Expand/Colapse</summary>

Have all the machines been identified? 
If you find futher traces of infection or new IOCs go back to the [Verify Step.](README.md#verify)  

When you are done identifying all compromised:  
- Hosts

And investigated all:  
- URLs
- Domains
- IP
- Ports
- Files
- Hash

</details>

### MA11. Do We Need External Help?
<details open>
<summary>Expand/Colapse</summary>

Depending on the depth and breath of the infection we might need so conseilling.  
Evalatuate of we need 
- Technical, Hands On, Response, etc. support 
- Legal conseilling (data breach, lots of clients affected, etc.)

If it's the case, contact our partners and activate the retainer.  

</details>

### MA16. Root Cause Analysis
<details open>
<summary>Expand/Colapse</summary>

How did this infection started?
- Phish
- Drive by download
- Vulnerability
    - RCE
    - XSS
    - LFI
- Remote services
    - Default / Weak password
    - Brute Force
    - Vulnerability
- USB key/drive

</details>

### MA17. Determine Mitre ATT&CK Stage
<details open>
<summary>Expand/Colapse</summary>
The [Mitre ATT&CK Framework]() as various [Tactics] that are part of a [Cyber Kill Chain].  
It is important to know at which stage of the Kill Chain the attack was detected and stoped.  

Document your ticket with the following information:
- Stage of detection
- Stage of prevention
- Was action on objective completed
    - File encrypted
    - Data exfiltrated
    - Account takeover
    - Etc. 

If data was exfiltrated go to the [Data Lost Playbook](../IRP-Data_Lost/)  

</details>

### MA18. Was Any Data Exfiltrated?
If we know or **suspect** that data was exfiltrated by the adversaries go to [Data Loss Playbook](../IRP-DataLoss/)

### MA19. Send communication
<details open>
<summary>Expand/Colapse</summary>

- Send a update communication to
    - Security Team
    - Admin Teams
    - Affected Syntac Entities
    - Affected Clients

</details>

Go to the next phase <Contain/Eradicate>
</details>


## 4. Contain / Eradicate
<details open>
<summary>Expand/Colapse</summary>

### Workflow
<details open>
<summary>Expand/Colapse</summary>

![Malware Workflow](Workflows/Malware-Workflow-Contain_Eradicate.png)

</details>

### MC1. Does the host have EDR?
<details open>
<summary>Expand/Colapse</summary>

If the host **have** an EDR installed go to the [Contain Section](README.md#contain-affected-hosts)  
  
If the host **does not have** an EDR, is it possible to install one?  

Yes: 
- Install EDR
- Go to [Contain section](README.md#contain-affected-hosts)

No: Isolate / Unplug the host
- Apply one of the following containment strategy
    - Remove/shutdown virtual interface
    - Put in "Dirty" VLAN
    - Shutdown switch port
- Go to [Action Taken section](README.md#action-taken-by-usercomputer)

</details>

### MC4. Contain Affected Hosts
<details open>
<summary>Expand/Colapse</summary>

- Update FW, Proxy, etc. rules
- Blackhole DNS
- Submit to Partners
    - AV/EDR Vendor
    - Web Filter Vendor
    - etc.

</details>

### MC7. Action Taken by User/Computer
<details open>
<summary>Expand/Colapse</summary>

Did the user: 
- Launch the malware
    - Open the document(s)
    - Run the executable
    - Launch the script

Did the computer / EDR:
- Connect to external site(s)
- Write files to disk
- Modified registry keys
- New services
    - Created
    - Launched
- New scheduled tasks
- New WMI provider(s)
- Block excution
- Quarantine file(s)

</details>

### MC8. Admin Rights?
<details open>
<summary>Expand/Colapse</summary>

In order to select the right eradication strategy we need to know in which context the malware was executed.  

Was the user admin/root of the machine or any other machines in the environment?  
  
Yes:  
- Wipe physical machine
- Delete virtual machine

No:   
- Delete all IOCs
    - Files
    - Registry keys
    - Services
    - Scheduled Tasks
    - WMI provider(s)
    - etc.

</details>

### MC11. Did Vendor Release New Signature?
<details open>
<summary>Expand/Colapse</summary>

Did the security vendor of the AV / EDR released a new engine, signature, policy to address the malware?  
  
No:  
- Go to [Close Monitoring](README.md#close-monitoring)  

Yes:  
- Upgrade security solution
- Update signatures
- Activate policy
- Scan systems enterprise wide 
    - Include customers if requiered

</details>

### MC14. Close Monitoring
<details open>
<summary>Expand/Colapse</summary>

- Monitor for: 
    - Internet connections to IOC
    - New files that matches hashes identified
    - Processes
    - Behaviors that matched identified TTPs
    
</details>


### MC15. All Affected Endpoints Contained?
<details open>
<summary>Expand/Colapse</summary>

If all affected endpoints have been contained, you can go to the <Recover> phase, otherwise continue bellow.  

</details>

### MC16. New IOC Discovered?
<details open>
<summary>Expand/Colapse</summary>

If there was new IOC discovered, go back to the [Analyze Phase](README.md#3-analyze)  

Otherwise continue with [host containment](README.md#does-the-host-have-edr)
</details>
</details>

## 5. Recover
<details open>
<summary>Expand/Colapse</summary>

### Workflow
<details open>
<summary>Expand/Colapse</summary>

![Malware Workflow](Workflows/Malware-Workflow-Recover.png)

</details>

### MR1. Rebuilt Systems
<details open>
<summary>Expand/Colapse</summary>

In an isolated environment:  
    - Install 
        - Supported OS
        - Security solutions
        - Up to date applications
    - Restore data (from a clean backup)

</details>

### MR2. Vulnerability Scan
<details open>
<summary>Expand/Colapse</summary>

Perform:  
- External VA
- If possible
    - Authenticated scan
    - Agent base scan

</details>

### MR3. Patch Vulnerabilities
<details open>
<summary>Expand/Colapse</summary>

Any **Critical** or **High** vulnerability needs to be patched **before** the service is reestablish. 
This include, but it not limited to 
- Operating Systems
- Applications
- Network Appliances

Medium and Low vulnerability should be patched if possible, but should not be mandatory for restoring the service/lifting containment. 
</details>

### MR4. Update Defenses
<details open>
<summary>Expand/Colapse</summary>

Determine which of the following rules needs to be removed and which needs to stay in the following list:  
- Firewall Rules
- EDR 
    - Ban hashes
    - Ban domains
    - Containment
- Proxy Block
- DNS Sinkhole
- Etc. 

</details>

### MR5. Restore Service
<details open>
<summary>Expand/Colapse</summary>

Depending on the containment applied to the host, perform all the following that applies:  
- Lift containment in EDR console
- Move host to production VLAN
- Enable switch port
- Enable/Create virtual network interface
- etc. 

</details>

### MR6. All Affected Endpoints Restored?
<details open>
<summary>Expand/Colapse</summary>

If all affected endpoints have been restored, you can go to the <Post Incident> phase, otherwise continue bellow.  
- List systems that haven't been restored
- Go to [README.md#rebuild-systems]

</details>

### MR8. Validate Countermeasures
<details open>
<summary>Expand/Colapse</summary>

Determine if legitimate elements are blocked by:  
- AV / EDR
- IPS
- Proxy
- Firewall
- DNS
- Etc.

If so, apply the corrective action to restore functionality  

</details>

### MR9. Was Malware Known Before
<details open>
<summary>Expand/Colapse</summary>

If the malware was **not known** before the incident
- Validate with the Global Security Team if you can submit the sample to 3rd parties like
    - VirusTotal
    - Hybrid-Analysis
    - Any.run
    - Threat Grig
    - Google Safe Browsing
    - OpenIOC
    - Etc.

</details>

</details>

## 6. Post Incident
<details>
<summary>Expand/Colapse</summary>

### Workflow
<details open>
<summary>Expand/Colapse</summary>

![Malware Workflow](Workflows/Malware-Workflow-Post%20Incident.png)

</details>

### MP1. Incident Review
<details open>
<summary>Expand/Colapse</summary>

- What worked
- What didn't work

</details>

### MP2. Update Policies & Procedures
<details open>
<summary>Expand/Colapse</summary>

Update the following documents as requiered:  
- Policies
- Processes
- Procedures
- Playbooks
- Runbooks

Update Detetion Rules in:  
- SIEM
- Malware Gataway
- AV / EDR
- IPS
- Other security solution

</details>

### MP3. Review Defensive Posture
<details open>
<summary>Expand/Colapse</summary>

- Schedule review of newly introduced rules in 6 months
- Are the following still applicatble
    - Firewall Rules
    - Proxy Rules for C2
    - AV / EDR custom Signatures
    - IPS Signatures
    - Etc.

</details>

### MP4. Update & Upgrade Defenses
<details open>
<summary>Expand/Colapse</summary>

As we still have multiple AV & EDR Vendor, we must ensure **ALL** of them can detect this malware familly in the future.  
Malware Sample should be sent to **ALL** AV and EDR vendor we work with. Once the AV/EDR vendor confirms they can detect the sample we need to make sure:   
- Anti-Virus 
    - Signatures are updated for all
        - Company Entities
        - Customers (Regardless of the region)
    - Engine are upgraded for all
        - Company Entities
        - Customers (Regardless of the region)
- EDR Rules
    - To detect the behaviors of the malware
- Mail Service
- Anti-Spam / Anti-Phish
- etc. 

</details>


### MP5. Build New Detections
<details open>
<summary>Expand/Colapse</summary>

SIEM Rules could be created to catch this type of behaviors and create tickets.

</details>

### MP6. Modifify Base Images
<details open>
<summary>Expand/Colapse</summary>

If the Malware Infection was caused by a lack of hardening or insufficient patch level: 
- Review hardening processes
- Include critical patches in base images
- Consider upgrading application
- Apply Security Patch to application
- etc. 

</details>

### MP8. User Awareness Training
<details open>
<summary>Expand/Colapse</summary>

If the incident was caused by a human error
- Create / Select new mandatory training
    - From Security Education Vendor
    - From Youtube video
    - Built by internal teams

</details>

### MP9. Calculate Incident's Cost
<details open>
<summary>Expand/Colapse</summary>


</details>

</details>

# References

This Playbook was built using the following references:  
https://www.dfir.training/index.php?option=com_jreviews&format=ajax&url=media/download&m=14tt1&1600804844570  
https://www.gov.scot/publications/cyber-resilience-incident-management/  
https://github.com/certsocietegenerale/IRM/tree/master/EN  
https://www.incidentresponse.com/playbooks/  
https://ayehu.com/cyber-security-incident-response-automation/top-5-cyber-security-incident-response-playbooks/  
https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-61r2.pdf  
